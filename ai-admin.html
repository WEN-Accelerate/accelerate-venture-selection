<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Configuration - Super Admin Console</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0 12px 12px 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.enabled {
            background: #d4edda;
            color: #155724;
        }

        .badge.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.research {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.general {
            background: #fff3cd;
            color: #856404;
        }

        .badge.fallback {
            background: #e2e3e5;
            color: #383d41;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #5a67d8;
            color: white;
        }

        .btn-primary:hover {
            background: #4c51bf;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 200px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #495057;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .close-btn:hover {
            color: #343a40;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ü§ñ AI Configuration Console</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('models')">Models</button>
            <button class="tab" onclick="switchTab('prompts')">Prompts</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Models Tab -->
        <div id="models-tab" class="tab-content active">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>AI Models Configuration</h3>
                    <button class="btn-success" onclick="showAddModel()">+ Add Model</button>
                </div>
                <div id="models-status"></div>
                <table id="models-table">
                    <thead>
                        <tr>
                            <th>Model Name</th>
                            <th>Version</th>
                            <th>Rank</th>
                            <th>Use Case</th>
                            <th>Web Search</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="models-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Prompts Tab -->
        <div id="prompts-tab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>AI Prompt Templates</h3>
                    <button class="btn-success" onclick="showAddPrompt()">+ Add Prompt</button>
                </div>
                <div id="prompts-status"></div>
                <table id="prompts-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Name</th>
                            <th>Web Search</th>
                            <th>JSON Schema</th>
                            <th>Temperature</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prompts-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h3>Global AI Settings</h3>
                <div id="settings-status"></div>
                <table id="settings-table">
                    <thead>
                        <tr>
                            <th>Setting Key</th>
                            <th>Value</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="settings-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Model Modal -->
    <div id="model-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="model-modal-title">Edit Model</h2>
                <button class="close-btn" onclick="closeModal('model-modal')">&times;</button>
            </div>
            <form id="model-form">
                <input type="hidden" id="model-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Model Name*</label>
                        <input type="text" id="model-name" required>
                    </div>
                    <div class="form-group">
                        <label>Version*</label>
                        <select id="model-version">
                            <option value="v1beta">v1beta</option>
                            <option value="v1">v1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rank (Priority)*</label>
                        <input type="number" id="model-rank" min="1" max="1000" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Use Case</label>
                        <select id="model-usecase">
                            <option value="general">General</option>
                            <option value="research">Research</option>
                            <option value="fallback">Fallback</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="model-websearch">
                            <label>Supports Web Search</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="model-enabled">
                            <label>Enabled</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="model-description">
                </div>
                <button type="submit" class="btn-primary">Save Model</button>
            </form>
        </div>
    </div>

    <!-- Edit Prompt Modal -->
    <div id="prompt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="prompt-modal-title">Edit Prompt</h2>
                <button class="close-btn" onclick="closeModal('prompt-modal')">&times;</button>
            </div>
            <form id="prompt-form">
                <input type="hidden" id="prompt-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Key (Unique ID)*</label>
                        <input type="text" id="prompt-key" required>
                    </div>
                    <div class="form-group">
                        <label>Display Name*</label>
                        <input type="text" id="prompt-name" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Prompt Template* (Use {variable} for placeholders)</label>
                    <textarea id="prompt-template" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Temperature</label>
                        <input type="number" id="prompt-temperature" min="0" max="1" step="0.1" value="0.2">
                    </div>
                    <div class="form-group">
                        <label>Max Tokens</label>
                        <input type="number" id="prompt-maxtokens" min="100" max="32000" value="8192">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="prompt-websearch">
                            <label>Enable Web Search</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="prompt-enabled">
                            <label>Enabled</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="prompt-description">
                </div>
                <button type="submit" class="btn-primary">Save Prompt</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Initialize Supabase - Auto-detect from environment
        const { createClient } = supabase;

        // Try to get from window (injected by Netlify) or use manual config
        const SUPABASE_URL = window.VITE_SUPABASE_URL || import.meta.env.VITE_SUPABASE_URL || 'https://kwmxhpajpxokbztokpxu.supabase.co';
        const SUPABASE_KEY = window.VITE_SUPABASE_ANON_KEY || import.meta.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3bXhocGFqcHhva2J6dG9rcHh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3OTMxNTUsImV4cCI6MjA1MjM2OTE1NX0.DkxyxKCpQDJQW6I9xGU0cAYyiApcxq0HjrKWSTOwsrE';

        console.log('üîß Supabase URL:', SUPABASE_URL);
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global state
        window.currentTab = 'models';
        window.supabase = sb;

        // Tab switching
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            window.currentTab = tabName;

            loadData(tabName);
        };

        // Load data
        window.loadData = async (type) => {
            if (type === 'models') await loadModels();
            if (type === 'prompts') await loadPrompts();
            if (type === 'settings') await loadSettings();
        };

        // Load models
        window.loadModels = async () => {
            const { data, error } = await sb.from('ai_models').select('*').order('rank', { ascending: false });

            if (error) {
                showStatus('models', 'error', 'Failed to load models: ' + error.message);
                return;
            }

            const tbody = document.getElementById('models-list');
            tbody.innerHTML = data.map(m => `
                <tr>
                    <td><strong>${m.name}</strong></td>
                    <td>${m.version}</td>
                    <td>${m.rank}</td>
                    <td><span class="badge ${m.use_case || 'general'}">${m.use_case || 'N/A'}</span></td>
                    <td>${m.supports_web_search ? '‚úÖ' : '‚ùå'}</td>
                    <td><span class="badge ${m.enabled ? 'enabled' : 'disabled'}">${m.enabled ? 'Enabled' : 'Disabled'}</span></td>
                    <td>
                        <button class="btn-primary btn-small" onclick="editModel('${m.id}')">Edit</button>
                        <button class="btn-danger btn-small" onclick="deleteModel('${m.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        // Load prompts
        window.loadPrompts = async () => {
            const { data, error } = await sb.from('ai_prompts').select('*');

            if (error) {
                showStatus('prompts', 'error', 'Failed to load prompts: ' + error.message);
                return;
            }

            const tbody = document.getElementById('prompts-list');
            tbody.innerHTML = data.map(p => `
                <tr>
                    <td><code>${p.key}</code></td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.use_web_search ? '‚úÖ' : '‚ùå'}</td>
                    <td>${p.use_json_schema ? '‚úÖ' : '‚ùå'}</td>
                    <td>${p.temperature || 0.2}</td>
                    <td><span class="badge ${p.enabled ? 'enabled' : 'disabled'}">${p.enabled ? 'Enabled' : 'Disabled'}</span></td>
                    <td>
                        <button class="btn-primary btn-small" onclick="editPrompt('${p.id}')">Edit</button>
                        <button class="btn-danger btn-small" onclick="deletePrompt('${p.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        // Load settings
        window.loadSettings = async () => {
            const { data, error } = await sb.from('ai_settings').select('*');

            if (error) {
                showStatus('settings', 'error', 'Failed to load settings: ' + error.message);
                return;
            }

            const tbody = document.getElementById('settings-list');
            tbody.innerHTML = data.map(s => `
                <tr>
                    <td><code>${s.key}</code></td>
                    <td><strong>${s.value}</strong></td>
                    <td>${s.description || 'N/A'}</td>
                    <td>
                        <button class="btn-primary btn-small">Edit</button>
                    </td>
                </tr>
            `).join('');
        };

        // Show status message
        window.showStatus = (tab, type, message) => {
            const statusDiv = document.getElementById(`${tab}-status`);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        };

        // Modal functions
        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('active');
        };

        window.showAddModel = () => {
            document.getElementById('model-modal-title').textContent = 'Add New Model';
            document.getElementById('model-form').reset();
            document.getElementById('model-id').value = '';
            document.getElementById('model-modal').classList.add('active');
        };

        window.showAddPrompt = () => {
            document.getElementById('prompt-modal-title').textContent = 'Add New Prompt';
            document.getElementById('prompt-form').reset();
            document.getElementById('prompt-id').value = '';
            document.getElementById('prompt-modal').classList.add('active');
        };

        window.editModel = async (id) => {
            const { data, error } = await sb.from('ai_models').select('*').eq('id', id).single();
            if (error) return alert('Failed to load model');

            document.getElementById('model-modal-title').textContent = 'Edit Model';
            document.getElementById('model-id').value = data.id;
            document.getElementById('model-name').value = data.name;
            document.getElementById('model-version').value = data.version;
            document.getElementById('model-rank').value = data.rank;
            document.getElementById('model-usecase').value = data.use_case || 'general';
            document.getElementById('model-websearch').checked = data.supports_web_search;
            document.getElementById('model-enabled').checked = data.enabled;
            document.getElementById('model-description').value = data.description || '';
            document.getElementById('model-modal').classList.add('active');
        };

        window.editPrompt = async (id) => {
            const { data, error } = await sb.from('ai_prompts').select('*').eq('id', id).single();
            if (error) return alert('Failed to load prompt');

            document.getElementById('prompt-modal-title').textContent = 'Edit Prompt';
            document.getElementById('prompt-id').value = data.id;
            document.getElementById('prompt-key').value = data.key;
            document.getElementById('prompt-name').value = data.name;
            document.getElementById('prompt-template').value = data.prompt_template;
            document.getElementById('prompt-temperature').value = data.temperature || 0.2;
            document.getElementById('prompt-maxtokens').value = data.max_tokens || 8192;
            document.getElementById('prompt-websearch').checked = data.use_web_search;
            document.getElementById('prompt-enabled').checked = data.enabled;
            document.getElementById('prompt-description').value = data.description || '';
            document.getElementById('prompt-modal').classList.add('active');
        };

        window.deleteModel = async (id) => {
            if (!confirm('Are you sure you want to delete this model?')) return;

            const { error } = await sb.from('ai_models').delete().eq('id', id);
            if (error) {
                showStatus('models', 'error', 'Failed to delete: ' + error.message);
            } else {
                showStatus('models', 'success', 'Model deleted successfully');
                loadModels();
            }
        };

        window.deletePrompt = async (id) => {
            if (!confirm('Are you sure you want to delete this prompt?')) return;

            const { error } = await sb.from('ai_prompts').delete().eq('id', id);
            if (error) {
                showStatus('prompts', 'error', 'Failed to delete: ' + error.message);
            } else {
                showStatus('prompts', 'success', 'Prompt deleted successfully');
                loadPrompts();
            }
        };

        // Form submissions
        document.getElementById('model-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('model-id').value;
            const modelData = {
                name: document.getElementById('model-name').value,
                version: document.getElementById('model-version').value,
                rank: parseInt(document.getElementById('model-rank').value),
                use_case: document.getElementById('model-usecase').value,
                supports_web_search: document.getElementById('model-websearch').checked,
                enabled: document.getElementById('model-enabled').checked,
                description: document.getElementById('model-description').value
            };

            let result;
            if (id) {
                result = await sb.from('ai_models').update(modelData).eq('id', id);
            } else {
                result = await sb.from('ai_models').insert([modelData]);
            }

            if (result.error) {
                showStatus('models', 'error', 'Failed to save: ' + result.error.message);
            } else {
                showStatus('models', 'success', 'Model saved successfully');
                closeModal('model-modal');
                loadModels();
            }
        });

        document.getElementById('prompt-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('prompt-id').value;
            const promptData = {
                key: document.getElementById('prompt-key').value,
                name: document.getElementById('prompt-name').value,
                prompt_template: document.getElementById('prompt-template').value,
                temperature: parseFloat(document.getElementById('prompt-temperature').value),
                max_tokens: parseInt(document.getElementById('prompt-maxtokens').value),
                use_web_search: document.getElementById('prompt-websearch').checked,
                enabled: document.getElementById('prompt-enabled').checked,
                description: document.getElementById('prompt-description').value
            };

            let result;
            if (id) {
                result = await sb.from('ai_prompts').update(promptData).eq('id', id);
            } else {
                result = await sb.from('ai_prompts').insert([promptData]);
            }

            if (result.error) {
                showStatus('prompts', 'error', 'Failed to save: ' + result.error.message);
            } else {
                showStatus('prompts', 'success', 'Prompt saved successfully');
                closeModal('prompt-modal');
                loadPrompts();
            }
        });

        // Initial load
        loadData('models');
    </script>
</body>

</html>
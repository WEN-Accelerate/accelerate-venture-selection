<!DOCTYPE html>
<html>

<head>
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }

        .test {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-left: 4px solid #0f0;
        }

        .error {
            border-left-color: #f00;
            color: #f00;
        }

        .success {
            border-left-color: #0f0;
            color: #0f0;
        }

        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>ðŸ”§ Supabase Connection Diagnostic</h1>
    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script>
        const output = document.getElementById('output');

        function log(title, content, isError = false) {
            const div = document.createElement('div');
            div.className = `test ${isError ? 'error' : 'success'}`;
            div.innerHTML = `<strong>${title}</strong><pre>${content}</pre>`;
            output.appendChild(div);
        }

        async function runTests() {
            // Test 1: Check if Supabase loaded
            log('Test 1: Supabase Library',
                typeof supabase !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded',
                typeof supabase === 'undefined'
            );

            if (typeof supabase === 'undefined') {
                log('ERROR', 'Supabase library failed to load from CDN', true);
                return;
            }

            // Test 2: Check credentials
            const url = 'https://kwmxhpajpxokbztokpxu.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3bXhocGFqcHhva2J6dG9rcHh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3OTMxNTUsImV4cCI6MjA1MjM2OTE1NX0.DkxyxKCpQDJQW6I9xGU0cAYyiApcxq0HjrKWSTOwsrE';

            log('Test 2: Credentials', `URL: ${url}\nKey: ${key.substring(0, 30)}...`);

            // Test 3: Create client
            let client;
            try {
                const { createClient } = supabase;
                client = createClient(url, key);
                log('Test 3: Create Client', 'âœ… Client created successfully');
            } catch (err) {
                log('Test 3: Create Client', `âŒ ${err.message}`, true);
                return;
            }

            // Test 4: Test basic connectivity
            log('Test 4: Connectivity', 'Testing connection...');
            try {
                const { data, error } = await client.from('profiles').select('id').limit(1);
                if (error) {
                    log('Test 4: Connectivity', `âš ï¸ Error but connected: ${error.message}\nCode: ${error.code}\nDetails: ${error.details}`);
                } else {
                    log('Test 4: Connectivity', `âœ… Connected! Found ${data ? data.length : 0} rows`);
                }
            } catch (err) {
                log('Test 4: Connectivity', `âŒ Exception: ${err.message}\n${err.stack}`, true);
            }

            // Test 5: Test ai_models table
            log('Test 5: AI Models Table', 'Querying ai_models...');
            try {
                const { data, error, count } = await client
                    .from('ai_models')
                    .select('*', { count: 'exact' });

                if (error) {
                    log('Test 5: AI Models', `âŒ Error:\n${JSON.stringify(error, null, 2)}`, true);
                    log('Error Details', `Message: ${error.message}\nCode: ${error.code}\nDetails: ${error.details}\nHint: ${error.hint}`);
                } else {
                    log('Test 5: AI Models', `âœ… Success! Found ${count} models\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (err) {
                log('Test 5: AI Models', `âŒ Exception: ${err.message}\n${err.stack}`, true);
            }

            // Test 6: Test ai_prompts table
            log('Test 6: AI Prompts Table', 'Querying ai_prompts...');
            try {
                const { data, error, count } = await client
                    .from('ai_prompts')
                    .select('*', { count: 'exact' });

                if (error) {
                    log('Test 6: AI Prompts', `âŒ Error:\n${JSON.stringify(error, null, 2)}`, true);
                } else {
                    log('Test 6: AI Prompts', `âœ… Success! Found ${count} prompts`);
                }
            } catch (err) {
                log('Test 6: AI Prompts', `âŒ Exception: ${err.message}`, true);
            }

            // Test 7: Network check
            log('Test 7: Direct API Test', 'Testing Supabase REST API directly...');
            try {
                const response = await fetch(`${url}/rest/v1/ai_models?select=*`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('Test 7: Direct API', `âœ… Direct API works! Got ${data.length} models\n${JSON.stringify(data, null, 2)}`);
                } else {
                    const text = await response.text();
                    log('Test 7: Direct API', `âŒ Status ${response.status}\n${text}`, true);
                }
            } catch (err) {
                log('Test 7: Direct API', `âŒ Fetch failed: ${err.message}`, true);
            }

            log('SUMMARY', 'All tests complete. Check results above.');
        }

        // Run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Me a Consultant - Quick Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .step {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        button {
            background: #D32F2F;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-weight: bold;
        }

        button:hover {
            background: #b71c1c;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .success {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }

        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .logout-btn {
            background: #ff5722;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .logout-btn:hover {
            background: #e64a19;
        }

        .not-logged-in {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            text-align: center;
        }

        #userInfo {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>

<body>
    <div class="card">
        <button class="logout-btn" onclick="handleLogout()" id="logoutBtn" style="display:none;">
            üö™ Log Out
        </button>

        <h1>üéØ Make Me a Consultant</h1>
        <p>This page will automatically add you as a consultant in the database.</p>

        <div id="notLoggedIn" class="not-logged-in" style="display:none;">
            <h3>‚ö†Ô∏è You're Not Logged In</h3>
            <p>You need to log in first before you can become a consultant.</p>
            <button onclick="netlifyIdentity.open()"
                style="background: #4CAF50; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                üîë Click Here to Log In
            </button>
        </div>

        <div id="mainContent" style="display:none;">
            <div class="step">
                <strong>Step 1:</strong> Log in to your account ‚úÖ (You're logged in!)
            </div>

            <div class="step">
                <strong>Step 2:</strong> Click the button below
            </div>

            <div class="step">
                <strong>Step 3:</strong> You'll be a consultant! üéâ
            </div>

            <div id="userInfo" style="display:none;">
                <strong>Your User Info:</strong><br>
                Email: <span id="userEmail"></span><br>
                Name: <span id="userName"></span><br>
                UID: <code id="userUID"></code>
            </div>

            <div class="info">
                <strong>‚ö†Ô∏è Important:</strong> Make sure you're logged in with the account you want to make a
                consultant.
            </div>

            <button id="makeConsultantBtn" onclick="addMeAsConsultant()">
                ‚ú® Make Me a Consultant Now
            </button>

            <div id="successMsg" class="success"></div>
            <div id="errorMsg" class="error"></div>

            <div class="info" style="margin-top: 30px;">
                <strong>What happens when you click?</strong><br>
                1. Checks if you're logged in<br>
                2. Gets your user ID automatically<br>
                3. Adds you to the consultants table in the database<br>
                4. Redirects you to the Consultant Dashboard
            </div>
        </div>
    </div>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script type="module">
        import { supabase } from '/src/supabaseClient.js';

        // Initialize Netlify Identity
        netlifyIdentity.init();

        // Check if user is logged in
        window.addEventListener('load', () => {
            const user = netlifyIdentity.currentUser();
            if (user) {
                // User is logged in - show main content
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('notLoggedIn').style.display = 'none';

                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userName').textContent = user.user_metadata?.full_name || 'Not set';
                document.getElementById('userUID').textContent = user.id;
                document.getElementById('userInfo').style.display = 'block';
            } else {
                // User is NOT logged in
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('notLoggedIn').style.display = 'block';
            }
        });

        // Listen for login events
        netlifyIdentity.on('login', () => {
            window.location.reload();
        });

        // Logout handler
        window.handleLogout = function () {
            if (confirm('Are you sure you want to log out?')) {
                netlifyIdentity.logout();
                window.location.reload();
            }
        };

        // Add consultant to database
        window.addMeAsConsultant = async function () {
            const btn = document.getElementById('makeConsultantBtn');
            const successMsg = document.getElementById('successMsg');
            const errorMsg = document.getElementById('errorMsg');

            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            btn.disabled = true;
            btn.textContent = '‚è≥ Processing...';

            try {
                // Get current user
                const user = netlifyIdentity.currentUser();

                if (!user) {
                    // User not logged in, open login modal
                    netlifyIdentity.open();
                    btn.disabled = false;
                    btn.textContent = '‚ú® Make Me a Consultant Now';

                    // Wait for login
                    netlifyIdentity.on('login', () => {
                        window.location.reload();
                    });
                    return;
                }

                console.log('User:', user);

                // Add to consultants table
                const { data, error } = await supabase
                    .from('consultants')
                    .insert([{
                        user_id: user.id,
                        email: user.email,
                        name: user.user_metadata?.full_name || user.email.split('@')[0]
                    }])
                    .select();

                if (error) {
                    // Check if already exists
                    if (error.code === '23505') {
                        successMsg.innerHTML = `
                            ‚úÖ You're already a consultant!<br>
                            Redirecting to your dashboard...
                        `;
                        successMsg.style.display = 'block';

                        setTimeout(() => {
                            window.location.href = '/dashboard.html';
                        }, 2000);
                        return;
                    }
                    throw error;
                }

                console.log('Success:', data);

                successMsg.innerHTML = `
                    üéâ <strong>Success!</strong><br><br>
                    You are now a consultant!<br>
                    Email: ${user.email}<br>
                    UID: ${user.id}<br><br>
                    Redirecting to your Consultant Dashboard...
                `;
                successMsg.style.display = 'block';

                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
                errorMsg.innerHTML = `
                    ‚ùå <strong>Error:</strong><br>
                    ${error.message}<br><br>
                    Please make sure:<br>
                    1. You ran the database migration in Supabase<br>
                    2. You're connected to the internet<br>
                    3. Try refreshing the page
                `;
                errorMsg.style.display = 'block';
                btn.disabled = false;
                btn.textContent = '‚ú® Try Again';
            }
        };
    </script>
</body>

</html>